<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ðŸ”§ HPC Cluster toeplitz.dm.unipi.it</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Highlight.js CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">

    <!-- Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>

    <style>
        body { font-family: Arial, sans-serif; padding-top: 20px; background-color: #f8f9fa; }
        #chat { max-height: 60vh; overflow-y: auto; border: 1px solid #dee2e6; padding: 10px; background-color: #fff; border-radius: 0.5rem; }
        .message { padding: 8px; margin: 4px; border-radius: 0.5rem; word-wrap: break-word; }
        .user { background-color: #d1e7dd; text-align: right; }
        .assistant { 
            background-color: #eeece9; 
            text-align: left; 
        }
        .assistant pre {
            background-color: #878181;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-12 col-md-8">
            <h2 class="mb-5 text-center">ðŸ”§ HPC Cluster toeplitz.dm.unipi.it</h2>

            <div id="chat" class="mb-3"></div>

            <div class="input-group mb-3">
                <input type="text" id="message" class="form-control" placeholder="Scrivi un messaggio..." onkeypress="handleKeyPress(event)">
                <button class="btn btn-primary" onclick="sendMessage()">Invia</button>
                <button class="btn btn-secondary" onclick="resetChat()">Reset</button>
            </div>
        </div>
    </div>
</div>

<script>
    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            const r = Math.random() * 16 | 0;
            const v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    let session_id =  (crypto && crypto.randomUUID) ? crypto.randomUUID() : generateUUID();

    function scrollToBottom() {
        const chatDiv = document.getElementById("chat");
        chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    async function sendMessage() {
        const input = document.getElementById("message");
        const message = input.value.trim();
        if (!message) return;

        const chatDiv = document.getElementById("chat");
        chatDiv.innerHTML += `<div class='message user'>${marked.parseInline(message)}</div>`;
        const assistantDiv = document.createElement('div');
        assistantDiv.className = 'message assistant';
        let content = "";
        chatDiv.appendChild(assistantDiv);
        input.value = "";

        // Add a bootstrap spinner as waiting indicator
        assistantDiv.innerHTML = `
            <div class="d-flex align-items-center">
                <div class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></div>
                <small class="text-muted">Sto pensando ...</small>
            </div>
        `;

        scrollToBottom();

        const response = await fetch(`/api/chat/stream`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({message, session_id})
        });

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let partial = '';

        while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            partial += decoder.decode(value, {stream:true});
            const lines = partial.split('\n');
            partial = lines.pop();

            for (const line of lines) {
                if (line.trim()) {
                    try {
                        const data = JSON.parse(line);
                        const msg = data['message'];
                        if (msg.role === 'assistant' && msg.content) {
                            content += msg.content;
                            assistantDiv.innerHTML = marked.parse(content);
                            assistantDiv.querySelectorAll('pre code').forEach((block) => hljs.highlightElement(block));
                            scrollToBottom();
                        }
                    } catch(e) { }
                }
            }
        }
    }

    async function resetChat() {
        session_id = (crypto && crypto.randomUUID) ? crypto.randomUUID() : generateUUID();
        document.getElementById("chat").innerHTML = "";
    }

    function handleKeyPress(event) {
        if (event.key === "Enter") {
            event.preventDefault();
            sendMessage();
        }
    }
</script>

<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
